
<!DOCTYPE html>
<html>
<head>
  <title>Add New Seismogram</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <a href="index.html">‚Üê Back to Home</a>
  <h1 style="text-align:center;">Add New Seismogram</h1>

<div class="columns">
  <div class="form-section">
    <h2>Image Details</h2>
  <!-- IMAGE TABLE -->
<form id="imageForm">
  <!-- Data Scanned-->
  <label>Date Scanned:</label><br>
  <input type="date" id="date_scanned"><br><br>
  <!-- RESOLUTION LABEL -->
  <!-- red asterisk for required label -->
  <label for="resolution">Resolution: <span style="color:red">*</span></label><br>
  <select id="resolution">
  <option value="" disabled selected>Choose...</option>
  <option value="300">300</option>
  <option value="600">600</option>
  <option value="1200">1200</option>
  <option value="361 (WWSSN)">361 (WWSSN)</option>
  <option value="other">Other</option>
  </select>
  <input type="number" id="custom_resolution" placeholder="Enter custom value" style="display:none;"><br><br>
  <!-- LENGTH LABEL -->
  <label>Length:</label><br>
  <input type="number" step="0.01" id="length"><br><br>
  <!-- WIDTH LABEL -->
  <label>Width:</label><br>
  <input type="number" step="0.01" id="width"><br><br>
  <!-- PHASE MARKINGS LABEL -->
  <label>Phase Markings:</label><br>
  <select id="phase_markings">
    <option value="" disabled selected>Choose...</option>
    <option value="True">True</option>
    <option value="False">False</option>
    <option value="NULL">Null</option>
  </select><br><br>
  <!-- BULLETIN LABEL -->
  <label>Bulletin:</label><br>
  <input type="text" id="bulletin"><br><br>
  <!-- OCCLUSIONS LABEL -->
  <label>Occlusions:</label><br>
  <select id="occlusions">
    <option value="" disabled selected>Choose...</option>
    <option value="True">True</option>
    <option value="False">False</option>
    <option value="NULL">Null</option>
  </select><br><br>
  <!-- RECORDING TYPE LABEL -->
  <label for="recording_type">Recording Type: <span style="color:red">*</span></label><br>
  <select id="recording_type">
  <option value="" disabled selected>Choose...</option>
  <option value="Photographic / Photosensitive">Photographic / Photosensitive</option>
  <option value="Thermal">Thermal</option>
  <option value="Ink">Ink</option>
  <option value="Smoke">Smoke</option>
  <option value="other">Other</option>
  </select>
  <input type="text" id="custom_recording_type" placeholder="Enter custom recording type" style="display:none;"><br><br>
  <!-- NOTES LABEL -->
  <label>Notes:</label><br>
  <textarea id="notes"></textarea><br><br>
  <!-- OWNER CONTACT LABEL -->
  <label>Owner Contact:</label><br>
  <input type="text" id="owner_contact"><br><br>
  <!-- CREATOR LABEL -->
  <label>Creator:</label><br>
  <input type="text" id="creator"><br><br>
  <!-- SIGNAL LABEL -->
  <label>Signal:</label><br>
  <select id="signal">
    <option value="" disabled selected>Choose...</option>
    <option value="True">True</option>
    <option value="False">False</option>
    <option value="NULL">Null</option>
  </select><br><br>
  <!-- TIMEMARK LABEL -->
  <label>Timemark:</label><br>
  <input type="datetime-local" id="timemark"><br><br>
</form>
</div>

<div class="form-section">
<h2>Sensor Details</h2>
<!-- SENSOR TABLE -->
<form id="sensorForm">
  <!-- SENSOR LABEL -->
  <label for="sensor">Sensor: <span style="color:red">*</span></label><br>
  <select id="sensor">
  <option value="" disabled selected>Choose...</option>
  <option value="Streckheisen STS-2">Streckheisen STS-2</option>
  <option value="Ewing">Ewing</option>
  <option value="Beniof">Beniof</option>
  <option value="other">Other</option>
  </select>
  <input type="varchar" id="custom_sensor" placeholder="Enter custom value" style="display:none;"><br><br>
  <!-- SENSOR SERIAL NUMBER LABEL -->
  <label>Sensor Serial Number:</label><br>
  <input type="integer" id="sensor_serial_number"><br><br>
  <!-- NATURE LABEL -->
  <label>Nature of Sensor:</label><br>
  <input type="varchar" id="sensor_nature"><br><br>
  <!-- GALVO FREE PERIOD LABEL -->
  <label for="free_period">Galvo Free Period: <span style="color:red">*</span></label><br>
  <input type="float" id="free_period"><br><br>
  <!-- DAMPING LABEL -->
  <label for="damping">Galvo Damping: <span style="color:red">*</span></label><br>
  <input type="integer" id="damping"><br><br>
</form>
</div>

<div class="form-section">
<h2>Equipment Details</h2>
<!-- EQUIPMENT TABLE -->
<form id="equipmentForm">
  <!-- CHANNEL LABEL -->
  <label for="channel">Channel: <span style="color:red">*</span></label><br>
  <input type="varchar" id="channel"><br><br>
  <!-- EQUIPMENT OPEN DATE LABEL -->
  <label>Equipment Open Date:</label><br>
  <input type="date" id="equip_open_date"><br><br>
  <!-- EQUIPMENT SERIAL NUMBER LABEL -->
  <label for="equip_serial_number">Equipment Serial Number: <span style="color:red">*</span></label><br>
  <input type="integer" id="equip_serial_number"><br><br>
  <!-- HORIZONTAL 1 DIP/AZIMUTH LABEL -->
  <label for="h_dip1">Horizontal 1 Dip/Azimuth: <span style="color:red">*</span></label><br>
  <input type="float" id="h_dip1"><br><br>
  <!-- HORIZONTAL 2 DIP/AZIMUTH LABEL -->
  <label for="h_dip2">Horizontal 2 Dip/Azimuth: <span style="color:red">*</span></label><br>
  <input type="float" id="h_dip2"><br><br>
  <!-- VERTICAL DIP/AZIMUTH LABEL -->
  <label for="v_dip">Vertical Dip/Azimuth: <span style="color:red">*</span></label><br>
  <input type="float" id="v_dip"><br><br>
  <!-- RECORDING SYSTEM LABEL -->
  <label for="recording_system">Recording System: <span style="color:red">*</span></label><br>
  <input type="varchar" id="recording_system"><br><br>
  <!-- RECORDING SERIAL NUMBER LABEL -->
  <label>Recording Serial Number:</label><br>
  <input type="integer" id="recording_serial_number"><br><br>
  <!-- EQUIPMENT GAIN LABEL-->
  <label>Equipment Gain:</label><br>
  <input type="integer" id="equip_gain"><br><br>
  <!-- PERIOD OF GAIN LABEL -->
  <label>Period of Gain:</label><br>
  <input type="float" id="period_of_gain"><br><br>
  <!-- NATURE OF EQUIPMENT LABEL -->
  <label>Nature of Equipment:</label><br>
  <input type="varchar" id="equip_nature"><br><br>
</form>
</div>
<button id="SubmitAll">Submit</button>
<p id="result"></p>


<p id="Result"></p>

  <script>

    document.addEventListener('DOMContentLoaded', () => {
      const SUPABASE_URL = 'https://ndysyydnaxtkwjikicoc.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5keXN5eWRuYXh0a3dqaWtpY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1ODAyNTQsImV4cCI6MjA2NzE1NjI1NH0.9LN1walCptD8bJkULcFjL2arqc4Ih-Rf3CRTJJ7_eyg';
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const resultBox = document.getElementById('Result');

    

        // ADD/HIDE CUSTOM FIELD
      document.getElementById('resolution').addEventListener('change', () => {
        document.getElementById('custom_resolution').style.display =
          document.getElementById('resolution').value === 'other' ? 'block' : 'none';
      });
      document.getElementById('recording_type').addEventListener('change', () => {
        document.getElementById('custom_recording_type').style.display =
          document.getElementById('recording_type').value === 'other' ? 'block' : 'none';
      });

      
        document.getElementById('sensor').addEventListener('change', () => {
        document.getElementById('custom_sensor').style.display =
        document.getElementById('sensor').value === 'other' ? 'block' : 'none';
         });
        document.getElementById('SubmitAll').addEventListener('click', async (e) => {
        e.preventDefault();
      

        // Validate all required fields before inserting anything
        const requiredFields = [
          { id: 'resolution', label: 'Resolution' },
          { id: 'recording_type', label: 'Recording Type' },
          { id: 'sensor', label: 'Sensor' },
          { id: 'free_period', label: 'Galvo Free Period' },
          { id: 'damping', label: 'Galvo Damping' },
          { id: 'channel', label: 'Channel' },
          { id: 'equip_serial_number', label: 'Equipment Serial Number' },
          { id: 'h_dip1', label: 'Horizontal 1 Dip/Azimuth' },
          { id: 'h_dip2', label: 'Horizontal 2 Dip/Azimuth' },
          { id: 'v_dip', label: 'Vertical Dip/Azimuth' },
          { id: 'recording_system', label: 'Recording System' }
        ];

        for (let field of requiredFields) {
          const el = document.getElementById(field.id);
          let value = el.value;

          // Handle custom options
          if (field.id === 'resolution' && value === 'other') {
            value = document.getElementById('custom_resolution').value;
          }
          if (field.id === 'recording_type' && value === 'other') {
            value = document.getElementById('custom_recording_type').value;
          }
          if (field.id === 'sensor' && value === 'other') {
            value = document.getElementById('custom_sensor').value;
          }

          if (!value || value.trim() === '') {
            alert(`Please enter a value for ${field.label}.`);
            return;
          }
        }

        // Now it's safe to proceed with the rest of the logic...
                // Required: Resolution
        let resolutionInput = document.getElementById('resolution').value;
        if (resolutionInput === '') {
          alert("Please choose a value for Resolution.");
          return;
        }
        let resolutionValue;
        if (resolutionInput === 'other') {
          resolutionValue = parseInt(document.getElementById('custom_resolution').value);
          if (isNaN(resolutionValue)) {
            alert("Please enter a valid custom resolution.");
            return;
          }
        } else if (resolutionInput === '361 (WWSSN)') {
          resolutionValue = 361;
        } else {
          resolutionValue = parseInt(resolutionInput);
        }

        // Required: Recording Type
        let recordingType = document.getElementById('recording_type').value;
        if (recordingType === '') {
          alert("Please choose a value for Recording Type.");
          return;
        }
        if (recordingType === 'other') {
          recordingType = document.getElementById('custom_recording_type').value.trim();
          if (!recordingType) {
            alert("Please enter a custom Recording Type.");
            return;
          }
        }

        //DROP-DOWN TABLE
        let sensorValue = document.getElementById('sensor').value;
        if (sensorValue === '') {
          alert("Please choose a value for Sensor.");
          return;
        }
        if (sensorValue === 'other') {
        sensorValue = document.getElementById('custom_sensor').value.trim();
        }
        if (!sensorValue) {
        sensorValue = null;
        }

        
        // Optional: Phase Markings, Occlusions, Signal
        const phaseMarkingsRaw = document.getElementById('phase_markings').value;
        let phaseMarkings = phaseMarkingsRaw === "True" ? true : phaseMarkingsRaw === "False" ? false : null;

        const occlusionsRaw = document.getElementById('occlusions').value;
        let occlusions = occlusionsRaw === "True" ? true : occlusionsRaw === "False" ? false : null;

        const signalRaw = document.getElementById('signal').value;
        let signal = signalRaw === "True" ? true : signalRaw === "False" ? false : null;
      
        // Insert into image table
        const { error: imageError } = await client.from('image').insert([{
          date_scanned: document.getElementById('date_scanned').value || null,
          resolution: resolutionValue,
          length: parseFloat(document.getElementById('length').value),
          width: parseFloat(document.getElementById('width').value),
          phase_markings: phaseMarkings,
          bulletin: document.getElementById('bulletin').value,
          occlusions: occlusions,
          recording_type: recordingType,
          notes: document.getElementById('notes').value,
          owner_contact: document.getElementById('owner_contact').value,
          creator: document.getElementById('creator').value,
          signal: signal,
          timemark: document.getElementById('timemark').value || null
        }]);
        if (imageError) {
          resultBox.textContent = 'Error inserting image: ' + imageError.message;
          return;
        }
        


        
        // Insert into sensor table

        console.log("Inserting sensor:", {
        sensor: sensorValue,
        sensor_serial_number: parseInt(document.getElementById('sensor_serial_number').value),
        sensor_nature: document.getElementById('sensor_nature').value,
        free_period: parseFloat(document.getElementById('free_period').value),
        damping: parseInt(document.getElementById('damping').value)
        });

        const { error: sensorError } = await client.from('sensor').insert([{
        sensor: sensorValue,
        sensor_serial_number: parseInt(document.getElementById('sensor_serial_number').value),
        sensor_nature: document.getElementById('sensor_nature').value,
        free_period: parseFloat(document.getElementById('free_period').value),
        damping: parseInt(document.getElementById('damping').value)
        }]);
        if (sensorError) {
          resultBox.textContent = 'Error inserting sensor: ' + sensorError.message;
          return;
        }

        // Insert into equipment table
        const { error: equipError } = await client.from('equipment').insert([{
          channel: document.getElementById('channel').value,
          equip_open_date: document.getElementById('equip_open_date').value  || null,
          equip_serial_number: parseInt(document.getElementById('equip_serial_number').value),
          h_dip1: parseFloat(document.getElementById('h_dip1').value),
          h_dip2: parseFloat(document.getElementById('h_dip2').value),
          v_dip: parseFloat(document.getElementById('v_dip').value),
          recording_system: document.getElementById('recording_system').value,
          recording_serial_number: parseInt(document.getElementById('recording_serial_number').value),
          equip_gain: parseInt(document.getElementById('equip_gain').value),
          period_of_gain: parseFloat(document.getElementById('period_of_gain').value),
          equip_nature: document.getElementById('equip_nature').value
        }]);
        if (equipError) {
          resultBox.textContent = 'Error inserting equipment: ' + equipError.message;
          return;
        }

        resultBox.textContent = 'Success! All records added.';
        document.getElementById('imageForm').reset();
        document.getElementById('sensorForm').reset();
        document.getElementById('equipmentForm').reset();
      });
    });
  </script>
</body>
</html>